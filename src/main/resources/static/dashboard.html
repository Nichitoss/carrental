<!doctype html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è - Car Rental</title>
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
<header>
    <div class="header-content">
        <h1>üöó Car Rental</h1>
        <nav>
            <a href="/index.html">–ì–ª–∞–≤–Ω–∞—è</a>
            <a href="/author.html">–û–± –∞–≤—Ç–æ—Ä–µ</a>
            <span id="userInfo" class="user-info"></span>
            <button id="logoutBtn" class="btn-logout">–í—ã—Ö–æ–¥</button>
        </nav>
    </div>
</header>
<main class="dashboard-main">
    <div class="dashboard-container">
        <!-- –ö–∞—Ç–∞–ª–æ–≥ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π -->
        <section class="card-section">
            <div class="section-header">
                <h2>üìã –ö–∞—Ç–∞–ª–æ–≥ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π</h2>
                <div class="header-actions">
                    <span id="vehiclesCount" class="badge">0</span>
                    <button id="addVehicleBtn" class="btn-primary hidden" onclick="showVehicleModal()">+ –î–æ–±–∞–≤–∏—Ç—å</button>
                </div>
            </div>
            <div class="filters" id="vehicleFilters">
                <input type="text" id="vehicleSearch" placeholder="–ü–æ–∏—Å–∫ –ø–æ –º–∞—Ä–∫–µ, –º–æ–¥–µ–ª–∏..." oninput="filterVehicles()">
                <select id="vehicleStatusFilter" onchange="filterVehicles()">
                    <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                    <option value="AVAILABLE">–î–æ—Å—Ç—É–ø–µ–Ω</option>
                    <option value="RENTED">–ê—Ä–µ–Ω–¥–æ–≤–∞–Ω</option>
                    <option value="MAINTENANCE">–û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ</option>
                </select>
                <select id="vehicleSort" onchange="filterVehicles()">
                    <option value="">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</option>
                    <option value="price">–ü–æ —Ü–µ–Ω–µ</option>
                    <option value="year">–ü–æ –≥–æ–¥—É</option>
                </select>
            </div>
            <div class="table-wrapper">
                <table id="vehicles" class="data-table">
                    <thead>
                        <tr>
                            <th>–ú–∞—Ä–∫–∞</th>
                            <th>–ú–æ–¥–µ–ª—å</th>
                            <th>–ì–æ–¥</th>
                            <th>–¶–µ–Ω–∞/–¥–µ–Ω—å</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th id="vehiclesActionsHeader" class="hidden">–î–µ–π—Å—Ç–≤–∏—è</th>
                            <th id="vehiclesRentHeader" class="hidden">–ê—Ä–µ–Ω–¥–∞</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="7" class="empty-state">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- –ê—Ä–µ–Ω–¥—ã -->
        <section class="card-section">
            <div class="section-header">
                <h2 id="rentalsTitle">üìÖ –ú–æ–∏ –∞—Ä–µ–Ω–¥—ã</h2>
                <div class="header-actions">
                    <span id="rentalsCount" class="badge">0</span>
                    <button id="addRentalBtn" class="btn-primary hidden" onclick="showRentalModal()">+ –°–æ–∑–¥–∞—Ç—å –∞—Ä–µ–Ω–¥—É</button>
                </div>
            </div>
            <div class="filters hidden" id="rentalFilters">
                <select id="rentalStatusFilter" onchange="filterRentals()">
                    <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                    <option value="ACTIVE">–ê–∫—Ç–∏–≤–Ω–∞</option>
                    <option value="COMPLETED">–ó–∞–≤–µ—Ä—à–µ–Ω–∞</option>
                    <option value="CANCELLED">–û—Ç–º–µ–Ω–µ–Ω–∞</option>
                </select>
            </div>
            <div class="table-wrapper">
                <table id="rentals" class="data-table">
                    <thead>
                        <tr>
                            <th>–ê–≤—Ç–æ–º–æ–±–∏–ª—å</th>
                            <th id="rentalClientHeader" class="hidden">–ö–ª–∏–µ–Ω—Ç</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–ù–∞—á–∞–ª–æ</th>
                            <th>–û–∫–æ–Ω—á–∞–Ω–∏–µ</th>
                            <th>–°—É–º–º–∞</th>
                            <th id="rentalsActionsHeader" class="hidden">–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="7" class="empty-state">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- –ü–ª–∞—Ç–µ–∂–∏ -->
        <section class="card-section">
            <div class="section-header">
                <h2 id="paymentsTitle">üí≥ –ú–æ–∏ –ø–ª–∞—Ç–µ–∂–∏</h2>
                <span id="paymentsCount" class="badge">0</span>
            </div>
            <div class="table-wrapper">
                <table id="payments" class="data-table">
                    <thead>
                        <tr>
                            <th>ID –∞—Ä–µ–Ω–¥—ã</th>
                            <th>–°—É–º–º–∞</th>
                            <th>–ú–µ—Ç–æ–¥</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–î–∞—Ç–∞ –æ–ø–ª–∞—Ç—ã</th>
                            <th id="paymentsActionsHeader" class="hidden">–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="6" class="empty-state">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∞) -->
        <section class="card-section hidden" id="usersSection">
            <div class="section-header">
                <h2>üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h2>
                <button class="btn-primary" onclick="showUserModal()">+ –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
            </div>
            <div class="table-wrapper">
                <table id="users" class="data-table">
                    <thead>
                        <tr>
                            <th>–õ–æ–≥–∏–Ω</th>
                            <th>Email</th>
                            <th>–ò–º—è</th>
                            <th>–†–æ–ª—å</th>
                            <th>–ê–∫—Ç–∏–≤–µ–Ω</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="6" class="empty-state">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>
    </div>
</main>

<!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->
<div id="vehicleModal" class="modal hidden">
    <div class="modal-content">
        <span class="close" onclick="closeModal('vehicleModal')">&times;</span>
        <h2 id="vehicleModalTitle">–î–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ–º–æ–±–∏–ª—å</h2>
        <form id="vehicleForm" onsubmit="saveVehicle(event)">
            <input type="hidden" id="vehicleId">
            <label>–ì–æ—Å. –Ω–æ–º–µ—Ä <input type="text" id="vehicleLicensePlate" required></label>
            <label>–ú–∞—Ä–∫–∞ <input type="text" id="vehicleManufacturer" required></label>
            <label>–ú–æ–¥–µ–ª—å <input type="text" id="vehicleModel" required></label>
            <label>–ì–æ–¥ <input type="number" id="vehicleYear" min="1900" max="2100" required></label>
            <label>–¶–µ–Ω–∞/–¥–µ–Ω—å <input type="number" id="vehiclePrice" step="0.01" min="0" required></label>
            <label>–°—Ç–∞—Ç—É—Å
                <select id="vehicleStatus" required>
                    <option value="AVAILABLE">–î–æ—Å—Ç—É–ø–µ–Ω</option>
                    <option value="RENTED">–ê—Ä–µ–Ω–¥–æ–≤–∞–Ω</option>
                    <option value="MAINTENANCE">–û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ</option>
                </select>
            </label>
            <label>–¶–≤–µ—Ç <input type="text" id="vehicleColor"></label>
            <label>–ü—Ä–æ–±–µ–≥ <input type="number" id="vehicleMileage" step="0.01" min="0"></label>
            <div class="modal-actions">
                <button type="submit" class="btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button type="button" class="btn-secondary" onclick="closeModal('vehicleModal')">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </form>
    </div>
</div>

<div id="rentalModal" class="modal hidden">
    <div class="modal-content">
        <span class="close" onclick="closeModal('rentalModal')">&times;</span>
        <h2>–°–æ–∑–¥–∞—Ç—å –∞—Ä–µ–Ω–¥—É</h2>
        <form id="rentalForm" onsubmit="saveRental(event)">
            <input type="hidden" id="rentalVehicleId">
            <label>–ê–≤—Ç–æ–º–æ–±–∏–ª—å
                <select id="rentalVehicleSelect" required>
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—å</option>
                </select>
            </label>
            <label>–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ <input type="date" id="rentalStartDate" required></label>
            <label>–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è <input type="date" id="rentalEndDate" required></label>
            <div id="rentalPriceInfo" style="padding: 1rem; background: #f0f0f0; border-radius: 8px; margin: 1rem 0;">
                <strong>–°—Ç–æ–∏–º–æ—Å—Ç—å:</strong> <span id="rentalTotalPrice">-</span>
            </div>
            <div class="modal-actions">
                <button type="submit" class="btn-primary">–°–æ–∑–¥–∞—Ç—å –∞—Ä–µ–Ω–¥—É</button>
                <button type="button" class="btn-secondary" onclick="closeModal('rentalModal')">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </form>
    </div>
</div>

<div id="toast" class="toast"></div>

<script>
    let currentUser = null;
    let allVehicles = [];
    let allRentals = [];
    let allPayments = [];
    let allUsers = [];

    async function api(path, options = {}) {
        const res = await fetch(path, {
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json',
                ...options.headers
            },
            ...options
        });
        if (res.status === 401) {
            window.location.href = '/login.html';
            throw new Error('Unauthorized');
        }
        if (!res.ok) {
            const text = await res.text();
            let errorMsg = text;
            try {
                const json = JSON.parse(text);
                errorMsg = json.message || json.error || text;
            } catch {}
            throw new Error(errorMsg);
        }
        return res.json();
    }

    function showToast(message, type = 'error') {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = `toast ${type} show`;
        setTimeout(() => toast.classList.remove('show'), 3000);
    }

    function formatDate(dateStr) {
        if (!dateStr) return '-';
        const date = new Date(dateStr);
        return date.toLocaleDateString('ru-RU');
    }

    function formatMoney(amount) {
        if (!amount) return '-';
        return new Intl.NumberFormat('ru-RU', {
            style: 'currency',
            currency: 'RUB'
        }).format(amount);
    }

    function getStatusBadge(status) {
        const badges = {
            'AVAILABLE': '<span class="badge badge-success">–î–æ—Å—Ç—É–ø–µ–Ω</span>',
            'RENTED': '<span class="badge badge-warning">–ê—Ä–µ–Ω–¥–æ–≤–∞–Ω</span>',
            'MAINTENANCE': '<span class="badge badge-danger">–û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ</span>',
            'ACTIVE': '<span class="badge badge-info">–ê–∫—Ç–∏–≤–Ω–∞</span>',
            'COMPLETED': '<span class="badge badge-success">–ó–∞–≤–µ—Ä—à–µ–Ω–∞</span>',
            'CANCELLED': '<span class="badge badge-danger">–û—Ç–º–µ–Ω–µ–Ω–∞</span>',
            'PAID': '<span class="badge badge-success">–û–ø–ª–∞—á–µ–Ω</span>',
            'PENDING': '<span class="badge badge-warning">–û–∂–∏–¥–∞–µ—Ç</span>',
            'FAILED': '<span class="badge badge-danger">–û—à–∏–±–∫–∞</span>'
        };
        return badges[status] || `<span class="badge">${status}</span>`;
    }

    function isAdmin() {
        return currentUser && currentUser.role === 'ADMIN';
    }

    function isManager() {
        return currentUser && (currentUser.role === 'MANAGER' || currentUser.role === 'ADMIN');
    }

    function isClient() {
        return currentUser && currentUser.role === 'CLIENT';
    }

    function showAdminFeatures() {
        if (isAdmin()) {
            document.getElementById('addVehicleBtn').classList.remove('hidden');
            document.getElementById('vehiclesActionsHeader').classList.remove('hidden');
            document.getElementById('usersSection').classList.remove('hidden');
            document.getElementById('rentalsTitle').textContent = 'üìÖ –í—Å–µ –∞—Ä–µ–Ω–¥—ã';
            document.getElementById('paymentsTitle').textContent = 'üí≥ –í—Å–µ –ø–ª–∞—Ç–µ–∂–∏';
            document.getElementById('rentalFilters').classList.remove('hidden');
            document.getElementById('addRentalBtn').classList.remove('hidden');
            document.getElementById('rentalsActionsHeader').classList.remove('hidden');
            document.getElementById('rentalClientHeader').classList.remove('hidden');
            document.getElementById('paymentsActionsHeader').classList.remove('hidden');
        } else if (isManager()) {
            document.getElementById('rentalsTitle').textContent = 'üìÖ –í—Å–µ –∞—Ä–µ–Ω–¥—ã';
            document.getElementById('paymentsTitle').textContent = 'üí≥ –í—Å–µ –ø–ª–∞—Ç–µ–∂–∏';
            document.getElementById('rentalFilters').classList.remove('hidden');
            document.getElementById('addRentalBtn').classList.remove('hidden');
            document.getElementById('rentalsActionsHeader').classList.remove('hidden');
            document.getElementById('rentalClientHeader').classList.remove('hidden');
        } else if (isClient()) {
            // –î–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Å–æ–∑–¥–∞–Ω–∏—è –∞—Ä–µ–Ω–¥—ã
            document.getElementById('addRentalBtn').classList.remove('hidden');
            document.getElementById('vehiclesRentHeader').classList.remove('hidden');
        }
    }

    function filterVehicles() {
        const search = document.getElementById('vehicleSearch').value.toLowerCase();
        const status = document.getElementById('vehicleStatusFilter').value;
        const sort = document.getElementById('vehicleSort').value;
        
        let filtered = [...allVehicles];
        
        if (search) {
            filtered = filtered.filter(v => 
                v.manufacturer.toLowerCase().includes(search) ||
                v.model.toLowerCase().includes(search) ||
                v.licensePlate.toLowerCase().includes(search)
            );
        }
        
        if (status) {
            filtered = filtered.filter(v => v.status === status);
        }
        
        if (sort === 'price') {
            filtered.sort((a, b) => a.dailyPrice - b.dailyPrice);
        } else if (sort === 'year') {
            filtered.sort((a, b) => b.year - a.year);
        }
        
        renderVehicles(filtered);
    }

    function filterRentals() {
        const status = document.getElementById('rentalStatusFilter').value;
        let filtered = [...allRentals];
        
        if (status) {
            filtered = filtered.filter(r => r.status === status);
        }
        
        renderRentals(filtered);
    }

    function renderVehicles(vehicles) {
        const tbody = document.querySelector('#vehicles tbody');
        const countEl = document.getElementById('vehiclesCount');
        
        if (countEl) countEl.textContent = vehicles.length;

        if (vehicles.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="empty-state">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
            return;
        }

        tbody.innerHTML = vehicles.map(v => {
            const actions = isAdmin() ? `
                <td>
                    <button class="btn-small" onclick="editVehicle(${v.id})">‚úèÔ∏è</button>
                    <button class="btn-small btn-danger" onclick="deleteVehicle(${v.id})">üóëÔ∏è</button>
                </td>
            ` : '<td></td>';
            
            const rentBtn = isClient() && v.status === 'AVAILABLE' ? `
                <td>
                    <button class="btn-small" onclick="rentVehicle(${v.id})">üöó –ê—Ä–µ–Ω–¥–æ–≤–∞—Ç—å</button>
                </td>
            ` : '<td></td>';
            
            return `
                <tr>
                    <td>${v.manufacturer || '-'}</td>
                    <td>${v.model || '-'}</td>
                    <td>${v.year || '-'}</td>
                    <td>${formatMoney(v.dailyPrice)}</td>
                    <td>${getStatusBadge(v.status)}</td>
                    ${actions}
                    ${rentBtn}
                </tr>
            `;
        }).join('');
    }

    function renderRentals(rentals) {
        const tbody = document.querySelector('#rentals tbody');
        const countEl = document.getElementById('rentalsCount');
        
        if (countEl) countEl.textContent = rentals.length;

        if (rentals.length === 0) {
            const colspan = isClient() ? '6' : '7';
            tbody.innerHTML = `<tr><td colspan="${colspan}" class="empty-state">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>`;
            return;
        }

        tbody.innerHTML = rentals.map(r => {
            const actions = isManager() ? `
                <td>
                    <button class="btn-small" onclick="updateRentalStatus(${r.id})">üîÑ</button>
                </td>
            ` : '<td></td>';
            
            const clientCell = !isClient() ? `<td>${r.username || '-'}</td>` : '';
            
            return `
                <tr>
                    <td>${r.vehicleModel || '-'}</td>
                    ${clientCell}
                    <td>${getStatusBadge(r.status)}</td>
                    <td>${formatDate(r.startDate)}</td>
                    <td>${formatDate(r.endDate)}</td>
                    <td>${formatMoney(r.totalPrice)}</td>
                    ${actions}
                </tr>
            `;
        }).join('');
    }

    function renderPayments(payments) {
        const tbody = document.querySelector('#payments tbody');
        const countEl = document.getElementById('paymentsCount');
        
        if (countEl) countEl.textContent = payments.length;

        if (payments.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="empty-state">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
            return;
        }

        tbody.innerHTML = payments.map(p => {
            const actions = isManager() ? `
                <td>
                    <button class="btn-small" onclick="updatePaymentStatus(${p.id})">üîÑ</button>
                </td>
            ` : '<td></td>';
            
            return `
                <tr>
                    <td>${p.rentalId || '-'}</td>
                    <td>${formatMoney(p.amount)}</td>
                    <td>${p.method || '-'}</td>
                    <td>${getStatusBadge(p.status)}</td>
                    <td>${p.paidAt ? formatDate(p.paidAt) : '-'}</td>
                    ${actions}
                </tr>
            `;
        }).join('');
    }

    function renderUsers(users) {
        const tbody = document.querySelector('#users tbody');
        if (!tbody) return;

        if (users.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="empty-state">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
            return;
        }

        tbody.innerHTML = users.map(u => `
            <tr>
                <td>${u.username}</td>
                <td>${u.email}</td>
                <td>${u.firstName} ${u.lastName}</td>
                <td>${u.role}</td>
                <td>${u.active ? '‚úÖ' : '‚ùå'}</td>
                <td>
                    <button class="btn-small" onclick="toggleUserActive(${u.id}, ${!u.active})">
                        ${u.active ? 'üîí –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å' : 'üîì –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å'}
                    </button>
                    <button class="btn-small" onclick="changeUserRole(${u.id})">üë§ –†–æ–ª—å</button>
                </td>
            </tr>
        `).join('');
    }

    function showVehicleModal(vehicle = null) {
        const modal = document.getElementById('vehicleModal');
        const form = document.getElementById('vehicleForm');
        const title = document.getElementById('vehicleModalTitle');
        
        if (vehicle) {
            title.textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∞–≤—Ç–æ–º–æ–±–∏–ª—å';
            document.getElementById('vehicleId').value = vehicle.id;
            document.getElementById('vehicleLicensePlate').value = vehicle.licensePlate || '';
            document.getElementById('vehicleManufacturer').value = vehicle.manufacturer || '';
            document.getElementById('vehicleModel').value = vehicle.model || '';
            document.getElementById('vehicleYear').value = vehicle.year || '';
            document.getElementById('vehiclePrice').value = vehicle.dailyPrice || '';
            document.getElementById('vehicleStatus').value = vehicle.status || 'AVAILABLE';
            document.getElementById('vehicleColor').value = vehicle.color || '';
            document.getElementById('vehicleMileage').value = vehicle.mileage || '';
        } else {
            title.textContent = '–î–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ–º–æ–±–∏–ª—å';
            form.reset();
            document.getElementById('vehicleId').value = '';
        }
        
        modal.classList.remove('hidden');
    }

    function closeModal(modalId) {
        document.getElementById(modalId).classList.add('hidden');
    }

    async function saveVehicle(e) {
        e.preventDefault();
        const id = document.getElementById('vehicleId').value;
        const data = {
            licensePlate: document.getElementById('vehicleLicensePlate').value,
            manufacturer: document.getElementById('vehicleManufacturer').value,
            model: document.getElementById('vehicleModel').value,
            year: parseInt(document.getElementById('vehicleYear').value),
            dailyPrice: parseFloat(document.getElementById('vehiclePrice').value),
            status: document.getElementById('vehicleStatus').value,
            color: document.getElementById('vehicleColor').value,
            mileage: parseFloat(document.getElementById('vehicleMileage').value) || 0
        };

        try {
            if (id) {
                await api(`/api/vehicles/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify(data)
                });
                showToast('–ê–≤—Ç–æ–º–æ–±–∏–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
            } else {
                await api('/api/vehicles', {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
                showToast('–ê–≤—Ç–æ–º–æ–±–∏–ª—å –¥–æ–±–∞–≤–ª–µ–Ω', 'success');
            }
            closeModal('vehicleModal');
            loadData();
        } catch (e) {
            showToast('–û—à–∏–±–∫–∞: ' + e.message, 'error');
        }
    }

    async function editVehicle(id) {
        const vehicle = allVehicles.find(v => v.id === id);
        if (vehicle) {
            showVehicleModal(vehicle);
        }
    }

    async function deleteVehicle(id) {
        if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∞–≤—Ç–æ–º–æ–±–∏–ª—å?')) return;
        try {
            await api(`/api/vehicles/${id}`, { method: 'DELETE' });
            showToast('–ê–≤—Ç–æ–º–æ–±–∏–ª—å —É–¥–∞–ª–µ–Ω', 'success');
            loadData();
        } catch (e) {
            showToast('–û—à–∏–±–∫–∞: ' + e.message, 'error');
        }
    }

    async function updateRentalStatus(id) {
        const rental = allRentals.find(r => r.id === id);
        if (!rental) return;
        
        const newStatus = prompt('–ù–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å (ACTIVE, COMPLETED, CANCELLED):', rental.status);
        if (!newStatus) return;
        
        try {
            await api(`/api/rentals/${id}/status`, {
                method: 'PUT',
                body: JSON.stringify({ status: newStatus })
            });
            showToast('–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
            loadData();
        } catch (e) {
            showToast('–û—à–∏–±–∫–∞: ' + e.message, 'error');
        }
    }

    async function updatePaymentStatus(id) {
        const payment = allPayments.find(p => p.id === id);
        if (!payment) return;
        
        const newStatus = prompt('–ù–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å (PENDING, PAID, FAILED, REFUNDED):', payment.status);
        if (!newStatus) return;
        
        try {
            await api(`/api/payments/${id}/status?status=${newStatus}`, {
                method: 'PUT'
            });
            showToast('–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
            loadData();
        } catch (e) {
            showToast('–û—à–∏–±–∫–∞: ' + e.message, 'error');
        }
    }

    async function toggleUserActive(id, active) {
        try {
            const endpoint = active ? `/api/users/${id}/unblock` : `/api/users/${id}/block`;
            await api(endpoint, { method: 'POST' });
            showToast(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${active ? '—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω' : '–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω'}`, 'success');
            loadUsers();
        } catch (e) {
            showToast('–û—à–∏–±–∫–∞: ' + e.message, 'error');
        }
    }

    async function changeUserRole(id) {
        const role = prompt('–ù–æ–≤–∞—è —Ä–æ–ª—å (ADMIN, MANAGER, CLIENT):');
        if (!role) return;
        
        try {
            await api(`/api/users/${id}/role/${role}`, { method: 'POST' });
            showToast('–†–æ–ª—å –∏–∑–º–µ–Ω–µ–Ω–∞', 'success');
            loadUsers();
        } catch (e) {
            showToast('–û—à–∏–±–∫–∞: ' + e.message, 'error');
        }
    }

    function showUserModal() {
        alert('–§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞');
    }

    function showRentalModal(vehicleId = null) {
        const modal = document.getElementById('rentalModal');
        const select = document.getElementById('rentalVehicleSelect');
        const startDate = document.getElementById('rentalStartDate');
        const endDate = document.getElementById('rentalEndDate');
        
        // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π
        select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—å</option>';
        allVehicles.filter(v => v.status === 'AVAILABLE').forEach(v => {
            const option = document.createElement('option');
            option.value = v.id;
            option.textContent = `${v.manufacturer} ${v.model} (${v.year}) - ${formatMoney(v.dailyPrice)}/–¥–µ–Ω—å`;
            if (vehicleId && v.id === vehicleId) {
                option.selected = true;
            }
            select.appendChild(option);
        });
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –¥–∞—Ç—É (—Å–µ–≥–æ–¥–Ω—è)
        const today = new Date().toISOString().split('T')[0];
        startDate.min = today;
        endDate.min = today;
        
        // –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω vehicleId, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –µ–≥–æ
        if (vehicleId) {
            document.getElementById('rentalVehicleId').value = vehicleId;
        } else {
            document.getElementById('rentalVehicleId').value = '';
        }
        
        // –û—á–∏—â–∞–µ–º –¥–∞—Ç—ã
        startDate.value = '';
        endDate.value = '';
        document.getElementById('rentalTotalPrice').textContent = '-';
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏
        select.onchange = calculateRentalPrice;
        startDate.onchange = calculateRentalPrice;
        endDate.onchange = calculateRentalPrice;
        
        modal.classList.remove('hidden');
    }

    function calculateRentalPrice() {
        const vehicleId = document.getElementById('rentalVehicleSelect').value;
        const startDate = document.getElementById('rentalStartDate').value;
        const endDate = document.getElementById('rentalEndDate').value;
        
        if (!vehicleId || !startDate || !endDate) {
            document.getElementById('rentalTotalPrice').textContent = '-';
            return;
        }
        
        const vehicle = allVehicles.find(v => v.id == vehicleId);
        if (!vehicle) return;
        
        const start = new Date(startDate);
        const end = new Date(endDate);
        const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
        
        if (days < 1) {
            document.getElementById('rentalTotalPrice').textContent = '–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞—Ç—ã';
            return;
        }
        
        const total = vehicle.dailyPrice * days;
        document.getElementById('rentalTotalPrice').textContent = formatMoney(total) + ` (${days} ${days === 1 ? '–¥–µ–Ω—å' : days < 5 ? '–¥–Ω—è' : '–¥–Ω–µ–π'})`;
    }

    function rentVehicle(vehicleId) {
        showRentalModal(vehicleId);
    }

    async function saveRental(e) {
        e.preventDefault();
        const vehicleId = document.getElementById('rentalVehicleSelect').value;
        const startDate = document.getElementById('rentalStartDate').value;
        const endDate = document.getElementById('rentalEndDate').value;
        
        if (!vehicleId || !startDate || !endDate) {
            showToast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
            return;
        }
        
        const data = {
            vehicleId: parseInt(vehicleId),
            startDate: startDate,
            endDate: endDate
        };
        
        try {
            await api('/api/rentals', {
                method: 'POST',
                body: JSON.stringify(data)
            });
            showToast('–ê—Ä–µ–Ω–¥–∞ —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ', 'success');
            closeModal('rentalModal');
            loadData();
        } catch (e) {
            showToast('–û—à–∏–±–∫–∞: ' + e.message, 'error');
        }
    }

    async function loadUserInfo() {
        try {
            currentUser = await api('/api/auth/me');
            const userInfo = document.getElementById('userInfo');
            if (userInfo && currentUser) {
                userInfo.textContent = `${currentUser.firstName} ${currentUser.lastName} (${currentUser.role})`;
            }
            showAdminFeatures();
        } catch (e) {
            console.error('Failed to load user info:', e);
        }
    }

    async function loadUsers() {
        if (!isAdmin()) return;
        try {
            allUsers = await api('/api/users');
            renderUsers(allUsers);
        } catch (e) {
            console.error('Failed to load users:', e);
        }
    }

    async function loadData() {
        try {
            const [vehicles, rentals, payments] = await Promise.all([
                api('/api/vehicles').catch(e => {
                    console.error('Vehicles load error:', e);
                    showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π: ' + e.message, 'error');
                    return [];
                }),
                api('/api/rentals').catch(e => {
                    console.error('Rentals load error:', e);
                    showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞—Ä–µ–Ω–¥: ' + e.message, 'error');
                    return [];
                }),
                api('/api/payments').catch(e => {
                    console.error('Payments load error:', e);
                    showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π: ' + e.message, 'error');
                    return [];
                })
            ]);

            allVehicles = vehicles || [];
            allRentals = rentals || [];
            allPayments = payments || [];

            renderVehicles(allVehicles);
            renderRentals(allRentals);
            renderPayments(allPayments);
            
            if (isAdmin()) {
                loadUsers();
            }
        } catch (e) {
            console.error('Load error:', e);
            showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + (e.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
        }
    }

    document.getElementById('logoutBtn').onclick = async () => {
        try {
            await fetch('/api/auth/logout', { method: 'POST', credentials: 'include' });
        } catch (e) {
            console.error('Logout error:', e);
        }
        window.location.href = '/login.html';
    };

    loadUserInfo();
    loadData();
</script>
</body>
</html>
